#include "../memorymap.h"
.global mutexLock
.global mutexUnlock
.global disableCurrentThread
.global enableThread
.global rwlockWriteLock
.global rwlockWriteUnlock
.global rwlockReadLock
.global rwlockReadUnlock
.extern writeNumber
.extern yield


// mutex with ticketing system.
// rdi= address to mutex
// mutex is a 64bit value representing:
// 63:32: next ticket
// 31:0 : current ticket
mutexLock:    
    push        %rax
    mov         $1,%rax
    lock xadd   %eax,(%rdi)
1:  cmp         %eax,4(%rdi)
    je          2f
    call        yield
    jmp         1b
2:  pop         %rax
    ret
    
mutexUnlock:       // rdi = mutext address
    lock incq   4(%rdi) 
    ret



////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
// rwlockWriteLock(%rdi=lock)
// lock format:
//   63:32: readCount
//   31:00: writeLock
// It would be possible to waste time when this function waits for readers to be 0
// another reader count constantly inc/dec 
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
rwlockWriteLock:
    // lock the write lock or wait if it is already.
1:  lock btsq   $0,(%rdi)
    jc          1b

    // Wait for readers to finish
1:  cmpl        $0,4(%rdi)
    jnz         1b      
    ret

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
// rwlockWriteUnlock(%rdi=lock)
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
rwlockWriteUnlock:
    btrq        $0,(%rdi)
    ret

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
// rwlockReadLock(%rdi=lock)
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
rwlockReadLock:
1:  lock incl   4(%rdi)
    
    bt          $0,(%rdi)
    jnc         3f    

    lock decl   4(%rdi)

    bt          $0,(%rdi)
    jnc         1b
    call        yield
    jmp         1b
    
3:  ret

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
// rwlockReadUnlock(%rdi=lock)
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
rwlockReadUnlock:
    lock decl   4(%rdi)
    ret

